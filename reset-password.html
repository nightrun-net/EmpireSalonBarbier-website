<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password</title>
  <style>
    body { font-family: sans-serif; background: #667eea; color: white; display:flex; justify-content:center; align-items:center; height:100vh; margin:0;}
    .container { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; width: 350px; }
    input, button { width: 100%; margin: 8px 0; padding: 10px; border-radius: 6px; border: none; font-size: 1rem;}
    button { background: #ffd166; cursor:pointer; color: #333; font-weight: 700;}
    button:hover { background: #f0b429; }
    .error { color: #ff6b6b; font-weight: 600; }
    .success { color: #4caf50; font-weight: 700; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Reset Your Password</h2>
    <input type="email" id="email" placeholder="Your email" required autocomplete="email" />
    <input type="password" id="password" placeholder="New password" minlength="6" required />
    <input type="password" id="confirmPassword" placeholder="Confirm password" minlength="6" required />
    <button id="resetBtn">Reset Password</button>
    <p id="msg" class=""></p>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.hash.slice(1));
      const accessToken = params.get('access_token');
      const type = params.get('type');

      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmInput = document.getElementById('confirmPassword');
      const resetBtn = document.getElementById('resetBtn');
      const msg = document.getElementById('msg');

      if (!accessToken || type !== 'recovery') {
        msg.textContent = "Invalid or missing reset token.";
        msg.className = "error";
        resetBtn.disabled = true;
        emailInput.disabled = true;
        passwordInput.disabled = true;
        confirmInput.disabled = true;
        return;
      }

      resetBtn.addEventListener('click', async () => {
        msg.textContent = '';
        msg.className = '';

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const confirmPassword = confirmInput.value.trim();

        if (!email) {
          msg.textContent = 'Email is required.';
          msg.className = 'error';
          return;
        }

        if (password.length < 6) {
          msg.textContent = 'Password must be at least 6 characters.';
          msg.className = 'error';
          return;
        }

        if (password !== confirmPassword) {
          msg.textContent = 'Passwords do not match.';
          msg.className = 'error';
          return;
        }

        resetBtn.disabled = true;
        resetBtn.textContent = 'Resetting...';

        try {
          const res = await fetch('https://afjtomvxgyqxkzpbjamb.supabase.co/auth/v1/user', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ password, email }),
          });

          const data = await res.json();

          if (!res.ok) {
            console.error('Supabase error:', data);
            throw new Error(data.msg || data.error_description || 'Failed to reset password.');
          }

          msg.textContent = 'Password reset successful! Redirecting to login...';
          msg.className = 'success';

          setTimeout(() => {
            window.location.href = '/login.html';
          }, 2500);
        } catch (error) {
          console.error('Reset error:', error);
          msg.textContent = error.message;
          msg.className = 'error';
          resetBtn.disabled = false;
          resetBtn.textContent = 'Reset Password';
        }
      });
    })();
  </script>
</body>
</html>
